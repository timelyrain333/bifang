# 钉钉机器人智能体配置指南

## ✅ 功能说明

现在支持通过钉钉自定义机器人实现智能体对话交互，您可以在钉钉群中直接与SecOps智能体对话，执行安全运营任务。

## 📋 配置步骤

### ⚠️ 重要说明

**钉钉自定义机器人**通常只能发送消息，不能接收消息。要实现对话交互，需要：

**方案1（推荐）**：使用**钉钉开放平台的企业应用**
- 需要企业管理员创建应用
- 支持接收消息和发送消息
- 功能最完整

**方案2**：使用**钉钉工作流机器人**（如果支持交互卡片）
- 部分场景支持交互

**方案3**：如果您的钉钉版本支持自定义机器人的消息回调，可以按以下步骤配置

---

### 1. 创建钉钉机器人/应用

#### 如果使用企业应用（推荐）：

1. 登录[钉钉开放平台](https://open.dingtalk.com/)
2. 创建企业内部应用或第三方企业应用
3. 开通"机器人"能力
4. 配置消息接收URL：`https://your-domain.com/api/dingtalk/bot/`
5. 获取AppKey、AppSecret等配置信息

#### 如果使用自定义机器人：

1. 打开钉钉群 → 群设置 → 智能群助手 → 添加机器人 → 自定义
2. 设置机器人名称（例如：SecOps智能体）
3. 选择"加签"安全方式（推荐）或"自定义关键词"
4. 复制Webhook地址和加签密钥
5. **注意**：自定义机器人通常不支持接收消息，只能主动发送

### 2. 配置系统

1. 登录Bifang系统
2. 进入"系统配置" → "钉钉配置"
3. 创建或编辑钉钉配置：
   - **配置名称**：例如"钉钉机器人"
   - **Webhook地址**：粘贴从钉钉复制的Webhook地址
   - **加签密钥**：粘贴从钉钉复制的加签密钥（如果使用了加签方式）
   - **启用钉钉通知**：勾选
   - **配置类型**：选择"钉钉配置"或"both"（如果同时需要阿里云配置）

### 3. 配置通义千问AI（必需）

1. 在"系统配置" → "通义千问AI配置"中：
   - 配置API Key
   - 配置API地址和模型名称
   - **启用AI解析**

### 4. 配置Webhook回调（仅企业应用）

如果使用企业应用，在钉钉开放平台配置：
- **消息接收URL**：`https://your-domain.com/api/dingtalk/bot/`
- **加签方式**：使用加签密钥验证消息来源

## 🚀 使用方法

### 方式1：@机器人（推荐）

在钉钉群中@机器人并发送指令：
```
@SecOps智能体 请捕获最新的漏洞并检查我的资产是否受影响
```

### 方式2：直接发送消息

如果配置了自定义关键词，可以直接发送包含关键词的消息。

## 💡 使用示例

### 示例1：采集漏洞
```
@SecOps智能体 请采集最近7天的漏洞信息
```

### 示例2：检查资产影响
```
@SecOps智能体 检查我的资产是否受最新漏洞影响
```

### 示例3：综合任务
```
@SecOps智能体 请捕获最新的漏洞并检查我的资产是否受影响
```

## 📊 消息格式

智能体会以Markdown格式返回消息，包含：
- 智能体回复
- 任务执行日志（实时）
- 漏洞列表（含披露时间）
- 受影响资产详情
- 安全建议

## ⚙️ 技术说明

### API接口
- **URL**: `/api/dingtalk/bot/`
- **方法**: POST
- **认证**: 不需要（AllowAny）
- **响应**: 立即返回确认，后台异步处理

### 消息处理流程
1. 接收钉钉消息 → 立即返回确认（5秒内）
2. 后台解析消息 → 调用智能体服务
3. 执行任务 → 流式收集结果
4. 分批发送回复 → 避免消息过长

### 对话历史
- 每个用户维护独立的对话历史（基于senderId）
- 保留最近5轮对话（10条消息）
- 支持上下文理解

## 🔒 安全建议

1. **使用加签方式**：推荐使用钉钉的加签安全方式，而不是IP白名单
2. **HTTPS**: 确保使用HTTPS协议
3. **Webhook保护**: 不要公开暴露Webhook地址
4. **权限控制**: 只添加必要的用户到钉钉群

## ❓ 常见问题

### Q: 钉钉机器人没有响应？
A: 检查：
1. 钉钉配置是否正确（Webhook地址、加签密钥）
2. 通义千问AI配置是否启用
3. 查看后端日志排查错误

### Q: 消息过长被截断？
A: 系统会自动分批发送长消息，确保完整显示。

### Q: 如何清除对话历史？
A: 重启后端服务会清除内存中的对话历史。

## 📝 注意事项

1. 钉钉要求5秒内响应，所以消息处理是异步的
2. 任务执行可能需要较长时间，请耐心等待
3. 建议在专门的安全运营群中使用
