# 云服务器管理功能说明文档

## 📋 功能概述

云服务器管理功能通过插件方式采集阿里云ECS资源数据，并在前端页面进行统一展示和管理。

### 支持的资源类型

1. **ECS实例** - 云服务器实例信息
2. **镜像** - 系统镜像信息
3. **磁盘** - 块存储设备信息
4. **快照** - 磁盘快照信息
5. **安全组** - 网络安全组及规则
6. **弹性网卡** - 网络接口卡信息

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install aliyun-python-sdk-core aliyun-python-sdk-ecs
```

### 2. 加载插件

```bash
python manage.py load_plugins
```

执行后会在数据库中注册 `data_aliyun_ecs` 插件。

### 3. 配置阿里云凭证

访问 **系统配置** 页面，配置阿里云凭证：
- AccessKey ID
- AccessKey Secret
- Region ID（如：cn-hangzhou）

### 4. 创建数据采集任务

访问 **任务管理** → **新建任务**：

- **任务名称**：阿里云ECS资源采集
- **插件**：data_aliyun_ecs
- **阿里云配置**：选择已配置的凭证
- **触发类型**：
  - `manual` - 手动执行
  - `cron` - 定时执行（推荐：`0 */1 * * *` 每小时执行）
  - `interval` - 间隔执行
- **任务配置**（JSON格式）：

```json
{
  "resource_types": [
    "ecs_instance",
    "ecs_image",
    "ecs_disk",
    "ecs_snapshot",
    "ecs_security_group",
    "ecs_network_interface"
  ]
}
```

**说明**：
- `resource_types` 参数可以指定要采集的资源类型
- 如果不指定，默认采集所有资源类型
- 可以只采集部分资源，例如：`["ecs_instance", "ecs_disk"]`

### 5. 执行任务

保存任务后，点击任务列表中的 **执行** 按钮，等待任务完成。

### 6. 查看数据

访问 **资产列表** → **云服务器** 页面查看采集的数据。

---

## 📱 前端功能说明

### 页面布局

云服务器页面采用标签页设计，每个标签页对应一种资源类型：

```
┌──────────────────────────────────────────────────┐
│  [ECS实例] [镜像] [磁盘] [快照] [安全组] [弹性网卡] │
├──────────────────────────────────────────────────┤
│  筛选: [状态▼] [名称/ID____] [查询] [重置] [导出] │
├──────────────────────────────────────────────────┤
│  资源列表表格                                     │
│  - 资源ID                                        │
│  - 名称                                          │
│  - 状态（带颜色标签）                            │
│  - 各资源类型的特有字段                          │
│  - 采集时间                                      │
│  - 操作（查看详情）                              │
└──────────────────────────────────────────────────┘
```

### 功能特性

#### 1. 标签页切换
- 点击不同标签页切换资源类型
- 切换时自动加载对应类型的资源数据
- 筛选条件自动重置

#### 2. 筛选功能
- **状态筛选**：根据资源状态过滤（如：Running、Stopped等）
- **关键词搜索**：搜索资源ID或名称
- 支持回车键快速搜索

#### 3. 数据展示
- 根据不同资源类型动态显示相关字段
- 状态标签使用不同颜色区分：
  - 绿色：正常运行/可用
  - 灰色：已停止
  - 黄色：启动中/创建中
  - 红色：错误/不可用

#### 4. 查看详情
- 点击"查看详情"按钮打开详情对话框
- 显示资源的完整信息
- 包含基本信息和详细数据两个部分

#### 5. 导出功能
- 点击"导出Excel"按钮导出当前筛选结果
- 导出文件格式：`.xlsx`
- 文件名包含资源类型和时间戳

---

## 📊 各资源类型字段说明

### ECS实例 (ecs_instance)

| 字段 | 说明 |
|------|------|
| InstanceId | 实例ID |
| InstanceName | 实例名称 |
| Status | 实例状态 |
| InstanceType | 实例规格 |
| RegionId | 地域ID |
| ZoneId | 可用区ID |
| Cpu | CPU核数 |
| Memory | 内存大小（GB） |
| OsName | 操作系统名称 |
| PublicIpAddress | 公网IP地址列表 |
| InnerIpAddress | 内网IP地址列表 |
| SecurityGroupIds | 关联的安全组ID列表 |

### 镜像 (ecs_image)

| 字段 | 说明 |
|------|------|
| ImageId | 镜像ID |
| ImageName | 镜像名称 |
| Status | 镜像状态 |
| ImageSize | 镜像大小（GB） |
| OSName | 操作系统名称 |
| Architecture | 架构类型（如：x86_64） |
| Platform | 平台类型 |
| CreationTime | 创建时间 |

### 磁盘 (ecs_disk)

| 字段 | 说明 |
|------|------|
| DiskId | 磁盘ID |
| DiskName | 磁盘名称 |
| Status | 磁盘状态 |
| DiskType | 磁盘类型 |
| Category | 磁盘分类 |
| Size | 磁盘大小（GB） |
| IOPS | 每秒读写次数 |
| InstanceIds | 挂载的实例ID列表 |
| Encrypted | 是否加密 |

### 快照 (ecs_snapshot)

| 字段 | 说明 |
|------|------|
| SnapshotId | 快照ID |
| SnapshotName | 快照名称 |
| Status | 快照状态 |
| SourceDiskId | 源磁盘ID |
| SourceDiskSize | 源磁盘大小（GB） |
| RetentionDays | 保留天数 |
| Progress | 创建进度 |
| CreationTime | 创建时间 |

### 安全组 (ecs_security_group)

| 字段 | 说明 |
|------|------|
| SecurityGroupId | 安全组ID |
| SecurityGroupName | 安全组名称 |
| Description | 描述信息 |
| VpcId | VPC ID |
| SecurityGroupType | 安全组类型 |
| Rules | 安全组规则（入站/出站） |

### 弹性网卡 (ecs_network_interface)

| 字段 | 说明 |
|------|------|
| NetworkInterfaceId | 网卡ID |
| Status | 网卡状态 |
| Type | 网卡类型 |
| PrivateIpAddress | 私网IP |
| PublicIpAddress | 公网IP |
| VpcId | VPC ID |
| VSwitchId | 交换机ID |
| InstanceId | 挂载的实例ID |
| MacAddress | MAC地址 |

---

## 🔧 高级配置

### Cron表达式示例

```
*/5 * * * *      # 每5分钟执行一次
0 */1 * * *      # 每小时执行一次
0 0 * * *        # 每天0点执行一次
0 0 * * 0        # 每周日凌晨执行一次
0 0 1 * *        # 每月1号凌晨执行一次
0 */6 * * *      # 每6小时执行一次
```

### 部分资源采集示例

如果只关心部分资源，可以修改任务配置：

#### 只采集ECS实例
```json
{
  "resource_types": ["ecs_instance"]
}
```

#### 采集实例和磁盘
```json
{
  "resource_types": ["ecs_instance", "ecs_disk"]
}
```

---

## 🛡️ 权限要求

确保阿里云AccessKey拥有以下权限：

- `ecs:DescribeInstances` - 查询实例
- `ecs:DescribeImages` - 查询镜像
- `ecs:DescribeDisks` - 查询磁盘
- `ecs:DescribeSnapshots` - 查询快照
- `ecs:DescribeSecurityGroups` - 查询安全组
- `ecs:DescribeSecurityGroupAttribute` - 查询安全组规则
- `ecs:DescribeNetworkInterfaces` - 查询弹性网卡

建议使用阿里云RAM创建专门的权限策略，授予最小必要权限。

---

## ❓ 常见问题

### Q1: 插件加载失败

**错误**：`阿里云ECS SDK未安装`

**解决**：
```bash
pip install aliyun-python-sdk-core aliyun-python-sdk-ecs
```

### Q2: 任务执行失败 - 认证错误

**错误**：`缺少阿里云认证配置`

**解决**：
1. 检查系统配置中的阿里云凭证是否填写
2. 确认AccessKey ID和Secret正确
3. 确认任务关联了正确的阿里云配置

### Q3: 任务执行失败 - 权限不足

**错误**：`服务器异常: 403`

**解决**：
1. 检查AccessKey是否拥有必要的ECS权限
2. 确认RAM用户权限策略配置正确
3. 联系阿里云管理员授权

### Q4: 数据未显示

**检查步骤**：
1. 确认任务已成功执行（检查任务执行记录）
2. 刷新云服务器页面
3. 检查任务配置中的资源类型是否正确
4. 查看浏览器控制台是否有错误信息

### Q5: 页面空白或路由错误

**解决**：
1. 确认前端已正确编译：`npm run build`
2. 重启前端开发服务器：`npm run serve`
3. 清除浏览器缓存

---

## 📈 性能优化建议

1. **合理设置采集频率**
   - 建议最小间隔为1小时
   - 避免频繁调用API导致限流

2. **按需采集资源**
   - 如果只关心实例和磁盘，只配置这两种资源类型
   - 减少不必要的API调用

3. **数据清理**
   - 定期清理旧的资产数据
   - 可通过数据库直接操作或编写清理脚本

---

## 🔄 数据更新机制

1. **自动更新**：通过定时任务定期采集最新数据
2. **手动更新**：在任务管理页面手动执行任务
3. **数据覆盖**：每次采集会更新已存在的资源数据

---

## 📞 技术支持

如有问题，请：
1. 查看任务执行日志
2. 检查Django日志：`logs/django.log`
3. 查看Celery worker日志
4. 联系系统管理员

---

## 📝 更新日志

### v1.0.0 (2024-02-15)
- ✨ 初始版本发布
- ✨ 支持ECS实例、镜像、磁盘、快照、安全组、弹性网卡采集
- ✨ 前端标签页展示
- ✨ 筛选和导出功能