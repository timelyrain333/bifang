# Bifang 本地服务启动指南

## 快速启动（推荐）

使用项目自带的启动脚本一键启动所有服务：

```bash
# 启动所有服务
./start.sh

# 停止所有服务
./stop.sh
```

---

## 详细启动步骤

### 1. 启动 Docker 容器服务

```bash
# 启动 Redis 容器
docker run -d --name bifang-redis --restart unless-stopped -p 6379:6379 redis:7-alpine

# 启动 HexStrike AI 容器（如果未启动）
docker run -d --name hexstrike-ai --restart unless-stopped \
  -p 8888:8888 \
  -e HEXSTRIKE_HOST=0.0.0.0 \
  -e HEXSTRIKE_PORT=8888 \
  bifang/hexstrike-ai:latest

# 或使用 docker-compose 启动
docker compose -f docker-compose.hexstrike.yml up -d
```

### 2. 启动本地服务

```bash
# 激活虚拟环境
source venv/bin/activate

# 启动 Django 后端
python manage.py runserver 0.0.0.0:8000 > logs/django.log 2>&1 &

# 启动 Celery Worker
celery -A app.celery_app worker -l info --logfile=logs/celery_worker.log --detach

# 启动 Celery Beat
celery -A app.celery_app beat -l info --logfile=logs/celery_beat.log --detach

# 启动钉钉 Stream 服务（禁用代理）
unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy
python manage.py start_dingtalk_stream > logs/dingtalk_stream.log 2>&1 &
```

### 3. 启动 Vue 前端

```bash
cd frontend
npm run serve
```

---

## 服务访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| Vue 前端 | http://localhost:8080 | 前端界面 |
| Django 后端 | http://localhost:8000 | REST API |
| Admin 后台 | http://localhost:8000/admin/ | 管理后台 |
| HexStrike AI | http://localhost:8888 | AI 安全评估服务 |
| Redis | localhost:6379 | 消息队列 |

---

## 查看服务状态

```bash
# 查看 Docker 容器状态
docker ps

# 查看服务日志
tail -f logs/django.log          # Django 日志
tail -f logs/celery_worker.log   # Celery Worker 日志
tail -f logs/celery_beat.log     # Celery Beat 日志
tail -f logs/dingtalk_stream.log # 钉钉 Stream 日志

# 查看进程
ps aux | grep -E "manage.py|celery|npm"
```

---

## 常见问题

### 1. Redis 连接失败

检查 Redis 容器是否正常运行：
```bash
docker ps | grep bifang-redis
docker logs bifang-redis
```

### 2. 端口已被占用

检查端口占用情况：
```bash
lsof -i :8000  # Django
lsof -i :6379  # Redis
lsof -i :8888  # HexStrike AI
lsof -i :8080  # Vue 前端
```

### 3. 虚拟环境未激活

确保使用虚拟环境：
```bash
source venv/bin/activate
python --version  # 应显示虚拟环境中的 Python 版本
```

### 4. 依赖缺失

重新安装依赖：
```bash
source venv/bin/activate
pip install -r requirements.txt

cd frontend
npm install
```

---

## 单独重启服务

### 重启 Django
```bash
pkill -f "manage.py runserver"
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000
```

### 重启 Celery Worker
```bash
pkill -f "celery.*worker"
source venv/bin/activate
celery -A app.celery_app worker -l info --detach
```

### 重启 Celery Beat
```bash
pkill -f "celery.*beat"
source venv/bin/activate
celery -A app.celery_app beat -l info --detach
```

### 重启钉钉 Stream
```bash
pkill -f "manage.py start_dingtalk_stream"
source venv/bin/activate
unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy
python manage.py start_dingtalk_stream > logs/dingtalk_stream.log 2>&1 &
```

### 重启 Docker 容器
```bash
docker restart bifang-redis
docker restart hexstrike-ai
```

---

## 停止所有服务

使用项目自带的停止脚本：

```bash
./stop.sh
```

或手动停止：

```bash
# 停止本地服务
pkill -f "manage.py runserver"
pkill -f "celery.*worker"
pkill -f "celery.*beat"
pkill -f "manage.py start_dingtalk_stream"

# 停止前端
cd frontend
# 按 Ctrl+C 停止 npm 进程

# 停止 Docker 容器
docker stop bifang-redis hexstrike-ai

# 如需删除容器
docker rm bifang-redis hexstrike-ai
```

---

## 开发模式建议

### 使用 tmux/screen 保持服务运行

```bash
# 使用 tmux
tmux new -s bifang
./start.sh

# 断开会话
Ctrl+B, D

# 重新连接
tmux attach -t bifang
```

### 前后端分离启动

**终端 1 - Django 后端**
```bash
source venv/bin/activate
python manage.py runserver 0.0.0.0:8000
```

**终端 2 - Celery Worker**
```bash
source venv/bin/activate
celery -A app.celery_app worker -l info
```

**终端 3 - Celery Beat**
```bash
source venv/bin/activate
celery -A app.celery_app beat -l info
```

**终端 4 - 钉钉 Stream**
```bash
source venv/bin/activate
unset HTTP_PROXY HTTPS_PROXY ALL_PROXY http_proxy https_proxy all_proxy
python manage.py start_dingtalk_stream
```

**终端 5 - Vue 前端**
```bash
cd frontend
npm run serve
```

---

## 注意事项

1. **虚拟环境**：确保所有 Python 命令都在虚拟环境中执行
2. **网络代理**：钉钉 Stream 服务需要禁用代理
3. **端口占用**：确保 6379、8000、8080、8888 端口未被占用
4. **日志监控**：启动后建议监控日志，确认服务正常运行
5. **数据库迁移**：首次启动或代码更新后执行 `python manage.py migrate`
6. **插件加载**：执行 `python manage.py load_plugins` 加载插件

---

## 快速命令参考

```bash
# 一键启动
./start.sh

# 一键停止
./stop.sh












# 查看所有服务状态
docker ps && ps aux | grep -E "manage.py|celery|npm"

# 查看所有日志
tail -f logs/django.log logs/celery_worker.log logs/celery_beat.log logs/dingtalk_stream.log
```
