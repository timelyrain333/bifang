# 飞书长连接配置指南

## 概述

飞书长连接方式允许您的应用通过WebSocket与飞书开放平台建立持久连接，直接接收事件推送，**无需公网地址或域名**。这种方式特别适合本地开发环境。

## 优势

- ✅ **无需公网地址**：只需确保本地服务器能够访问公网，无需配置公网IP或域名
- ✅ **简化安全处理**：SDK内置了鉴权和加密逻辑，建立连接时进行鉴权，后续事件推送为明文数据
- ✅ **降低开发成本**：相比传统的Webhook模式，长连接方式大大降低了接入成本

## 配置步骤

### 1. 安装飞书Python SDK

```bash
pip install larksuite-oapi
```

### 2. 创建飞书机器人应用

1. 登录飞书开放平台：https://open.feishu.cn/
2. 创建自建应用 → 机器人应用
3. 在"凭证与基础信息"页面，获取：
   - **App ID**
   - **App Secret**

### 3. 配置权限

在应用的"权限管理"中，添加以下权限：
- `im:message` - 获取与发送单聊、群组消息
- `im:message.group_at_msg` - 接收群聊中@机器人消息事件

### 4. 配置事件订阅

1. 在应用的"事件订阅"页面
2. 选择**"使用长连接接收事件"**
3. 订阅以下事件：
   - `im.message.receive_v1` - 接收消息事件

### 5. 在Bifang系统中配置

1. 进入"系统配置" → "飞书配置"
2. 点击"新增配置"或编辑现有配置
3. 填写以下信息：
   - **配置名称**：例如"飞书长连接配置"
   - **使用长连接**：开启此选项
   - **飞书App ID**：从飞书开放平台获取
   - **飞书App Secret**：从飞书开放平台获取
   - **飞书Webhook**：**可选**，仅在使用自定义机器人时需要。企业自建应用不需要配置Webhook，系统会使用SDK API发送消息
   - **飞书签名密钥**：如果使用自定义机器人的Webhook并启用了签名校验，填写此字段
   - **启用飞书通知**：开启此选项
   - **通义千问AI配置**：确保已配置，用于智能体对话功能

**重要说明**：
- **企业自建应用**：不需要配置Webhook，系统会通过SDK API直接发送消息
- **自定义机器人**：需要配置Webhook地址，用于发送消息

### 6. 启动长连接服务

在终端中运行以下命令：

```bash
# 启动所有启用的长连接配置
python manage.py start_feishu_long_connection

# 或启动指定配置
python manage.py start_feishu_long_connection --config-id 1
```

服务启动后，会显示类似以下信息：
```
找到 1 个启用的配置，正在启动...
启动配置 1 (飞书长连接配置)...
配置 1 已启动

长连接服务正在运行，按 Ctrl+C 停止
```

### 7. 测试

在飞书群中 @ 机器人发送消息，例如：
```
@SecOps 请捕获最新的漏洞并检查我的资产是否受影响
```

机器人会调用SecOps智能体处理并回复。

## 注意事项

### 1. Webhook地址（可选）

**企业自建应用**：
- ✅ **不需要配置Webhook**，系统会通过SDK API直接发送消息
- 长连接用于接收事件，SDK API用于发送消息

**自定义机器人**：
- ⚠️ **需要配置Webhook**，用于发送消息到飞书群
- 注意：自定义机器人不支持长连接接收事件，只能通过Webhook接收

### 2. 保持服务运行

长连接服务需要持续运行才能接收事件。建议：
- 使用 `screen` 或 `tmux` 保持会话
- 或使用 `systemd` 服务（Linux）
- 或使用 `Supervisor` 管理进程

### 3. 多个配置

如果配置了多个飞书长连接，服务会同时启动所有启用的配置。

### 4. 日志查看

查看后端日志确认连接状态：
```bash
# 查看Django日志
tail -f logs/django.log

# 或查看Celery日志
tail -f logs/celery_worker.log
```

## 故障排查

### 问题1：连接失败

**症状**：服务启动后无法建立连接

**解决方案**：
1. 检查App ID和App Secret是否正确
2. 检查网络连接是否正常
3. 查看日志中的错误信息

### 问题2：收不到消息

**症状**：发送消息后机器人无响应

**解决方案**：
1. 确认长连接服务正在运行
2. 确认事件订阅已配置（`im.message.receive_v1`）
3. 确认权限已申请并审核通过
4. 查看日志确认是否收到事件

### 问题3：智能体无响应

**症状**：收到消息但智能体不回复

**解决方案**：
1. 确认已配置通义千问AI
2. 确认AI配置已启用
3. 确认Webhook地址已配置（用于发送回复）
4. 查看日志确认处理过程

## 与Webhook方式的对比

| 特性 | 长连接方式 | Webhook方式 |
|------|-----------|------------|
| 公网地址 | ❌ 不需要 | ✅ 需要 |
| 配置复杂度 | ⭐⭐ 简单 | ⭐⭐⭐⭐ 复杂 |
| 安全性 | ✅ SDK内置 | ⚠️ 需要自行处理 |
| 稳定性 | ✅ 自动重连 | ⚠️ 依赖网络 |
| 适用场景 | 本地开发、生产环境 | 生产环境（有公网地址） |

## 相关文档

- [飞书开放平台文档](https://open.feishu.cn/document/)
- [飞书Python SDK文档](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/server-side-sdk/python--sdk)
- [事件订阅配置](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN/event-subscription-configure-/request-url-configuration-case)

