<template>
  <div class="vulnerability-list">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>{{ pageTitle }}</span>
        </div>
      </template>
      
      <!-- 查询表单 -->
      <el-form :inline="true" :model="filters" class="query-form">
        <el-form-item :label="currentSource === 'cnvd' ? '编号' : 'CVE编号'">
          <el-input v-model="filters.cve_id" :placeholder="currentSource === 'cnvd' ? '请输入CNVD/CVE编号' : '请输入CVE编号'" clearable style="width: 200px" />
        </el-form-item>
        <el-form-item label="标题">
          <el-input v-model="filters.title" placeholder="请输入标题" clearable style="width: 200px" />
        </el-form-item>
        <el-form-item label="发布日期">
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
            style="width: 240px"
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" :icon="Search" @click="handleQuery">查询</el-button>
          <el-button :icon="Refresh" @click="resetFilters">重置</el-button>
          <el-button type="success" @click="handleExport" :loading="exporting">导出Excel</el-button>
          <el-button v-if="currentSource === 'cnvd'" type="warning" @click="importDialogVisible = true">导入XML</el-button>
        </el-form-item>
      </el-form>
      
      <!-- 漏洞列表表格 -->
      <el-table 
        :data="vulnerabilities" 
        v-loading="loading"
        stripe
        style="width: 100%"
        @row-click="showDetail"
      >
        <el-table-column prop="cve_id" :label="currentSource === 'cnvd' ? '编号' : 'CVE编号'" width="150" />
        <el-table-column prop="title" label="标题" min-width="300" show-overflow-tooltip />
        <el-table-column prop="published_date" label="发布日期" width="120">
          <template #default="{ row }">
            {{ row.published_date || '-' }}
          </template>
        </el-table-column>
        <el-table-column prop="source" label="数据来源" width="120" />
        <el-table-column prop="collected_at" label="采集时间" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.collected_at) }}
          </template>
        </el-table-column>
        <el-table-column label="操作" width="250" fixed="right">
          <template #default="{ row }">
            <el-button type="primary" link size="small" @click.stop="showDetail(row)">
              查看详情
            </el-button>
            <el-button type="success" link size="small" @click.stop="handleSendToDingtalk(row)" :loading="sendingDingtalk === row.id">
              发送钉钉
            </el-button>
            <el-button type="warning" link size="small" @click.stop="handleSendToFeishu(row)" :loading="sendingFeishu === row.id">
              发送飞书
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分页 -->
      <el-pagination
        v-model:current-page="currentPage"
        v-model:page-size="pageSize"
        :page-sizes="[10, 20, 50, 100]"
        :total="total"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="loadVulnerabilities"
        @current-change="loadVulnerabilities"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
    
    <!-- 详情对话框 -->
    <el-dialog
      v-model="detailDialogVisible"
      title="漏洞详情"
      width="80%"
      :close-on-click-modal="false"
    >
      <div v-if="currentVulnerability" class="vulnerability-detail">
        <!-- 基本信息 -->
        <el-card class="detail-card" shadow="never">
          <template #header>
            <span>基本信息</span>
          </template>
          <el-descriptions :column="3" border>
            <el-descriptions-item :label="currentSource === 'cnvd' ? '编号' : 'CVE编号'">
              {{ currentVulnerability.cve_id || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="标题">
              {{ currentVulnerability.title || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="发布日期">
              {{ currentVulnerability.published_date || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="数据来源">
              {{ currentVulnerability.source || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="消息ID">
              {{ currentVulnerability.message_id || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="采集时间">
              {{ formatDateTime(currentVulnerability.collected_at) }}
            </el-descriptions-item>
            <el-descriptions-item :label="(currentVulnerability.source === 'cnvd' ? '详情链接' : '邮件链接')" :span="3">
              <el-link :href="currentVulnerability.source_url" target="_blank" type="primary">
                {{ currentVulnerability.source_url }}
              </el-link>
            </el-descriptions-item>
          </el-descriptions>
        </el-card>
        
        <!-- 基本描述 -->
        <el-card v-if="getContentField('basic_description') || currentVulnerability.title" class="detail-card" shadow="never">
          <template #header>
            <span>基本描述</span>
          </template>
          <div class="content-box">
            <div v-if="getContentField('basic_description')" class="content-text">
              {{ getContentField('basic_description') }}
            </div>
            <div v-else-if="currentVulnerability.title" class="content-text">
              {{ currentVulnerability.title }}
            </div>
            <span v-else>-</span>
          </div>
        </el-card>
        
        <!-- 漏洞描述 -->
        <el-card v-if="getContentField('vulnerability_description') || currentVulnerability.description" class="detail-card" shadow="never">
          <template #header>
            <span>漏洞描述</span>
          </template>
          <div class="content-box">
            <pre v-if="getContentField('vulnerability_description')" class="content-text">{{ getContentField('vulnerability_description') }}</pre>
            <pre v-else-if="currentVulnerability.description" class="content-text">{{ currentVulnerability.description }}</pre>
            <span v-else>-</span>
          </div>
        </el-card>
        
        <!-- 漏洞影响 -->
        <el-card v-if="getContentField('impact')" class="detail-card" shadow="never">
          <template #header>
            <span>漏洞影响</span>
          </template>
          <div class="content-box">
            <pre class="content-text">{{ getContentField('impact') }}</pre>
          </div>
        </el-card>
        
        <!-- 详细信息卡片 -->
        <el-card class="detail-card" shadow="never">
          <template #header>
            <span>详细信息</span>
          </template>
          <el-descriptions :column="2" border>
            <el-descriptions-item label="漏洞危害等级">
              {{ getContentField('severity') || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="影响组件">
              {{ getContentField('affected_component') || '-' }}
            </el-descriptions-item>
            <el-descriptions-item label="影响版本" :span="2">
              <pre v-if="getContentField('affected_versions')" style="margin: 0; white-space: pre-wrap;">{{ getContentField('affected_versions') }}</pre>
              <span v-else>-</span>
            </el-descriptions-item>
            <el-descriptions-item label="解决方案" :span="2">
              <pre v-if="getContentField('solution')" style="margin: 0; white-space: pre-wrap;">{{ getContentField('solution') }}</pre>
              <span v-else>-</span>
            </el-descriptions-item>
            <el-descriptions-item label="临时缓解措施" :span="2">
              <pre v-if="getContentField('mitigation')" style="margin: 0; white-space: pre-wrap;">{{ getContentField('mitigation') }}</pre>
              <span v-else>-</span>
            </el-descriptions-item>
            <el-descriptions-item label="参考链接" :span="2">
              <div v-if="getReferences().length > 0">
                <el-link 
                  v-for="(ref, index) in getReferences()" 
                  :key="index"
                  :href="ref" 
                  target="_blank" 
                  type="primary"
                  style="margin-right: 10px; margin-bottom: 5px; display: inline-block;"
                >
                  {{ ref }}
                </el-link>
              </div>
              <span v-else>-</span>
            </el-descriptions-item>
          </el-descriptions>
        </el-card>
        
        <!-- 原始内容（可选，用于调试） -->
        <el-card v-if="showRawContent" class="detail-card" shadow="never">
          <template #header>
            <span>原始邮件内容</span>
          </template>
          <div class="content-box">
            <pre class="content-text raw-content">{{ currentVulnerability.raw_content }}</pre>
          </div>
        </el-card>
      </div>
      
      <template #footer>
        <el-button @click="detailDialogVisible = false">关闭</el-button>
        <el-button type="info" @click="showRawContent = !showRawContent">
          {{ showRawContent ? '隐藏' : '显示' }}原始内容
        </el-button>
      </template>
    </el-dialog>

    <!-- CNVD XML 导入对话框 -->
    <el-dialog
      v-model="importDialogVisible"
      title="导入 CNVD 漏洞 XML"
      width="480px"
      :close-on-click-modal="false"
      @closed="onImportDialogClosed"
    >
      <p class="import-tip">请选择从 CNVD 导出的 XML 文件（根节点为 vulnerabilitys，子节点为 vulnerability）。</p>
      <el-upload
        ref="importUploadRef"
        :auto-upload="false"
        :limit="1"
        accept=".xml"
        :on-change="onImportFileChange"
        :on-exceed="() => ElMessage.warning('每次仅支持上传一个文件')"
      >
        <template #trigger>
          <el-button type="primary">选择 XML 文件</el-button>
        </template>
        <template #tip>
          <div class="el-upload__tip">仅支持 .xml 文件</div>
        </template>
      </el-upload>
      <div v-if="importFile" class="import-file-name">{{ importFile.name }}</div>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="importDialogVisible = false">取消</el-button>
          <el-button type="primary" :loading="importing" :disabled="!importFile" @click="handleImportXml">
            确定导入
          </el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { useRoute } from 'vue-router'
import { Search, Refresh } from '@element-plus/icons-vue'
import { ElMessage } from 'element-plus'
import { getVulnerabilities, exportVulnerabilities, sendVulnerabilityToDingtalk, sendVulnerabilityToFeishu, uploadCnvdXml } from '../api/vulnerability'
import axios from 'axios'

export default {
  name: 'VulnerabilityList',
  setup() {
    const route = useRoute()
    const pageTitle = computed(() => route.meta?.title || '漏洞情报')
    const currentSource = computed(() => route.meta?.source || null)

    const loading = ref(false)
    const exporting = ref(false)
    const sendingDingtalk = ref(null)
    const sendingFeishu = ref(null)
    const vulnerabilities = ref([])
    const total = ref(0)
    const currentPage = ref(1)
    const pageSize = ref(20)
    const detailDialogVisible = ref(false)
    const currentVulnerability = ref(null)
    const showRawContent = ref(false)
    const importDialogVisible = ref(false)
    const importUploadRef = ref(null)
    const importFile = ref(null)
    const importing = ref(false)
    
    const filters = reactive({
      cve_id: '',
      title: '',
      published_date_from: '',
      published_date_to: ''
    })
    
    const dateRange = computed({
      get: () => {
        if (filters.published_date_from && filters.published_date_to) {
          return [filters.published_date_from, filters.published_date_to]
        }
        return null
      },
      set: (value) => {
        if (value && value.length === 2) {
          filters.published_date_from = value[0]
          filters.published_date_to = value[1]
        } else {
          filters.published_date_from = ''
          filters.published_date_to = ''
        }
      }
    })
    
    const loadVulnerabilities = async () => {
      loading.value = true
      try {
        const params = {
          page: currentPage.value,
          page_size: pageSize.value
        }
        if (currentSource.value) {
          params.source = currentSource.value
        }
        if (filters.cve_id) {
          params.cve_id = filters.cve_id
        }
        if (filters.title) {
          params.title = filters.title
        }
        if (filters.published_date_from) {
          params.published_date_from = filters.published_date_from
        }
        if (filters.published_date_to) {
          params.published_date_to = filters.published_date_to
        }
        
        const response = await getVulnerabilities(params)
        vulnerabilities.value = response.results || (Array.isArray(response) ? response : [])
        total.value = response.count || vulnerabilities.value.length
      } catch (error) {
        console.error('加载漏洞列表失败:', error)
        ElMessage.error('加载漏洞列表失败')
        vulnerabilities.value = []
        total.value = 0
      } finally {
        loading.value = false
      }
    }
    
    const handleQuery = () => {
      currentPage.value = 1
      loadVulnerabilities()
    }
    
    const resetFilters = () => {
      filters.cve_id = ''
      filters.title = ''
      filters.published_date_from = ''
      filters.published_date_to = ''
      dateRange.value = null
      currentPage.value = 1
      loadVulnerabilities()
    }
    
    const showDetail = (vulnerability) => {
      currentVulnerability.value = vulnerability
      detailDialogVisible.value = true
      showRawContent.value = false
    }
    
    const formatDateTime = (dateStr) => {
      if (!dateStr) return '-'
      const date = new Date(dateStr)
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      })
    }
    
    const formatFieldValue = (value) => {
      if (value === null || value === undefined || value === '') {
        return '-'
      }
      if (typeof value === 'object') {
        return JSON.stringify(value, null, 2)
      }
      return String(value)
    }
    
    const getFieldLabel = (key) => {
      const labelMap = {
        'cve_ids': 'CVE编号列表',
        'headers': '邮件头信息',
        'description': '描述',
        'raw_headers': '原始头信息'
      }
      return labelMap[key] || key
    }
    
    const getContentField = (fieldName) => {
      if (!currentVulnerability.value || !currentVulnerability.value.content) {
        return null
      }
      return currentVulnerability.value.content[fieldName] || null
    }
    
    const getReferences = () => {
      const refs = getContentField('references')
      if (Array.isArray(refs)) {
        return refs
      }
      return []
    }
    
    const handleSendToDingtalk = async (vulnerability) => {
      sendingDingtalk.value = vulnerability.id
      try {
        await sendVulnerabilityToDingtalk(vulnerability.id)
        ElMessage.success('漏洞信息已发送到钉钉群')
      } catch (error) {
        console.error('发送钉钉消息失败:', error)
        ElMessage.error(error.response?.data?.error || '发送失败，请检查钉钉配置')
      } finally {
        sendingDingtalk.value = null
      }
    }
    
    const handleSendToFeishu = async (vulnerability) => {
      sendingFeishu.value = vulnerability.id
      try {
        await sendVulnerabilityToFeishu(vulnerability.id)
        ElMessage.success('漏洞信息已发送到飞书群')
      } catch (error) {
        console.error('发送飞书消息失败:', error)
        ElMessage.error(error.response?.data?.error || '发送失败，请检查飞书配置')
      } finally {
        sendingFeishu.value = null
      }
    }
    
    const onImportFileChange = (file) => {
      importFile.value = file?.raw || null
    }
    const onImportDialogClosed = () => {
      importFile.value = null
      if (importUploadRef.value) {
        importUploadRef.value.clearFiles()
      }
    }
    const handleImportXml = async () => {
      if (!importFile.value) return
      importing.value = true
      try {
        const res = await uploadCnvdXml(importFile.value)
        const msg = res?.message || '导入完成'
        const total = res?.total ?? 0
        const created = res?.created ?? 0
        const updated = res?.updated ?? 0
        ElMessage.success(`${msg}：共 ${total} 条，新增 ${created} 条，更新 ${updated} 条`)
        importDialogVisible.value = false
        onImportDialogClosed()
        loadVulnerabilities()
      } catch (error) {
        const errMsg = error.response?.data?.error || error.response?.data?.detail || '导入失败'
        const detail = error.response?.data?.detail
        ElMessage.error(typeof detail === 'string' ? `${errMsg}：${detail}` : errMsg)
      } finally {
        importing.value = false
      }
    }

    const handleExport = async () => {
      exporting.value = true
      try {
        const params = {}
        if (currentSource.value) {
          params.source = currentSource.value
        }
        if (filters.cve_id) {
          params.cve_id = filters.cve_id
        }
        if (filters.title) {
          params.title = filters.title
        }
        if (filters.published_date_from) {
          params.published_date_from = filters.published_date_from
        }
        if (filters.published_date_to) {
          params.published_date_to = filters.published_date_to
        }
        
        const response = await axios.get('/api/vulnerabilities/export/', {
          params,
          responseType: 'blob',
          withCredentials: true
        })
        
        const blob = new Blob([response.data], { 
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        })
        const url = window.URL.createObjectURL(blob)
        const link = document.createElement('a')
        link.href = url
        
        const contentDisposition = response.headers['content-disposition'] || ''
        let filename = `漏洞情报库导出_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.xlsx`
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/)
          if (filenameMatch && filenameMatch[1]) {
            filename = decodeURIComponent(filenameMatch[1].replace(/['"]/g, ''))
          }
        }
        
        link.download = filename
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        window.URL.revokeObjectURL(url)
        
        ElMessage.success('导出成功！')
      } catch (error) {
        console.error('导出失败:', error)
        ElMessage.error('导出失败，请稍后重试')
      } finally {
        exporting.value = false
      }
    }
    
    watch(
      () => route.path,
      () => {
        currentPage.value = 1
        loadVulnerabilities()
      }
    )

    onMounted(() => {
      loadVulnerabilities()
    })
    
    return {
      pageTitle,
      currentSource,
      loading,
      exporting,
      sendingDingtalk,
      sendingFeishu,
      vulnerabilities,
      total,
      currentPage,
      pageSize,
      filters,
      dateRange,
      detailDialogVisible,
      currentVulnerability,
      showRawContent,
      Search,
      Refresh,
      loadVulnerabilities,
      handleQuery,
      resetFilters,
      showDetail,
      formatDateTime,
      formatFieldValue,
      getFieldLabel,
      handleExport,
      handleSendToDingtalk,
      handleSendToFeishu,
      getContentField,
      getReferences,
      importDialogVisible,
      importUploadRef,
      importFile,
      importing,
      onImportFileChange,
      onImportDialogClosed,
      handleImportXml
    }
  }
}
</script>

<style scoped>
.vulnerability-list {
  padding: 20px;
}

.card-header {
  font-weight: bold;
  font-size: 16px;
}

.query-form {
  margin-bottom: 20px;
}

.detail-card {
  margin-bottom: 20px;
}

.content-box {
  max-height: 500px;
  overflow-y: auto;
  padding: 10px;
  background-color: #f5f5f5;
  border-radius: 4px;
}

.content-text {
  white-space: pre-wrap;
  word-wrap: break-word;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.6;
  margin: 0;
}

.raw-content {
  font-size: 11px;
  max-height: 400px;
}

.el-table {
  cursor: pointer;
}

.import-tip {
  margin-bottom: 16px;
  color: #606266;
  font-size: 14px;
}
.import-file-name {
  margin-top: 8px;
  font-size: 13px;
  color: #409eff;
}
</style>

